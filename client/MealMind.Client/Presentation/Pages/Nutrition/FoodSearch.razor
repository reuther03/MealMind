@page "/nutrition/food-search"
@using MealMind.Client.Infrastructure.Abstractions
@using MealMind.Shared.Contracts.Dto.Nutrition
@using MealMind.Shared.Contracts.Pagination
@inject IApiClient IApiClient
@inject NavigationManager Navigation

<div class="food-search-page">
    @if (_selectedFood is null)
    {
        <!-- Search View -->
        <div class="search-header">
            <a href="/nutrition?date=@Date.ToString("yyyy-MM-dd")" class="back-btn">&#8592; Back</a>
            <h2>Add Food</h2>
        </div>

        <div class="search-box">
            <input type="text"
                   @bind="_prompt"
                   @bind:event="oninput"
                   @bind:after="SubmitPrompt"
                   placeholder="Search food..."
                   class="search-input"/>
            @if (!string.IsNullOrEmpty(_prompt))
            {
                <button type="button" class="clear-btn" @onclick="ClearSearch">&#215;</button>
            }
        </div>

        @if (_isLoading)
        {
            <div class="loading-state">
                <span class="loading"></span>
                <span>Searching...</span>
            </div>
        }
        else if (_errorMessage is not null)
        {
            <div class="alert alert-error">@_errorMessage</div>
        }
        else if (_foods?.Items.Any() == true)
        {
            <div class="search-results">
                @foreach (var food in _foods.Items)
                {
                    <div class="food-result-item" @onclick="() => SelectedFood(food)">
                        <div class="food-info">
                            <span class="food-name">@food.Name</span>
                            @if (!string.IsNullOrEmpty(food.Brand))
                            {
                                <span class="food-brand">(@food.Brand)</span>
                            }
                        </div>
                        <span class="food-calories">@((int)(food.NutritionPer100G?.Calories ?? 0)) cal</span>
                    </div>
                }
            </div>
        }
        else if (!string.IsNullOrEmpty(_prompt))
        {
            <div class="empty-state">No foods found</div>
        }

        <a href="nutrition/add-custom-food">Add custom food</a>
    }
    else
    {
        <!-- Detail View -->
        <div class="search-header">
            <button type="button" class="back-btn" @onclick="ClearSelection">&#8592; Back</button>
            <h2>Food Details</h2>
        </div>

        <div class="food-detail-card">
            <div class="food-detail-header">
                <h3>@_selectedFood.Name</h3>
                <span class="food-brand">@(_selectedFood.Brand ?? "Generic")</span>
            </div>

            <div class="quantity-section">
                <label>Quantity (g):</label>
                <input type="number" @bind="_model.QuantityInGrams" @bind:event="oninput" class="quantity-input"/>
            </div>

            @if (_selectedFood.NutritionPer100G is not null)
            {
                <div class="nutrition-section">
                    <div class="nutrition-label">For @((int)_model.QuantityInGrams)g</div>
                    <div class="macro-grid">
                        <div class="macro-card">
                            <div
                                class="macro-value">@((int)(_selectedFood.NutritionPer100G.Calories * _model.QuantityInGrams / 100))</div>
                            <div class="macro-label">cal</div>
                        </div>
                        <div class="macro-card">
                            <div
                                class="macro-value">@((int)(_selectedFood.NutritionPer100G.Protein * _model.QuantityInGrams / 100))g
                            </div>
                            <div class="macro-label">protein</div>
                        </div>
                        <div class="macro-card">
                            <div
                                class="macro-value">@((int)(_selectedFood.NutritionPer100G.Carbohydrates * _model.QuantityInGrams / 100))g
                            </div>
                            <div class="macro-label">carbs</div>
                        </div>
                        <div class="macro-card">
                            <div
                                class="macro-value">@((int)(_selectedFood.NutritionPer100G.Fat * _model.QuantityInGrams / 100))g
                            </div>
                            <div class="macro-label">fat</div>
                        </div>
                    </div>
                    @if (_selectedFood.NutritionPer100G.Fiber is not null || _selectedFood.NutritionPer100G.Sugar is not null)
                    {
                        <div class="macro-grid secondary">
                            @if (_selectedFood.NutritionPer100G.Fiber is not null)
                            {
                                <div class="macro-card small">
                                    <div
                                        class="macro-value">@((int)(_selectedFood.NutritionPer100G.Fiber.Value * _model.QuantityInGrams / 100))g
                                    </div>
                                    <div class="macro-label">fiber</div>
                                </div>
                            }
                            @if (_selectedFood.NutritionPer100G.Sugar is not null)
                            {
                                <div class="macro-card small">
                                    <div
                                        class="macro-value">@((int)(_selectedFood.NutritionPer100G.Sugar.Value * _model.QuantityInGrams / 100))g
                                    </div>
                                    <div class="macro-label">sugar</div>
                                </div>
                            }
                            @if (_selectedFood.NutritionPer100G.Sodium is not null)
                            {
                                <div class="macro-card small">
                                    <div
                                        class="macro-value">@((int)(_selectedFood.NutritionPer100G.Sodium.Value * _model.QuantityInGrams / 100))mg
                                    </div>
                                    <div class="macro-label">sodium</div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }

            <button type="button" class="add-btn" @onclick="AddFood">
                Add to @GetMealName()
            </button>
        </div>
    }
</div>

@code {

    [SupplyParameterFromQuery]
    private DateOnly Date { get; set; }

    [SupplyParameterFromQuery]
    private int MealType { get; set; }

    private AddFoodModel _model = new();

    private string? _prompt = string.Empty;
    private PaginatedList<FoodDto>? _foods;
    private FoodDto? _selectedFood;
    private CancellationTokenSource? _cts;

    private bool _isLoading;
    private string? _errorMessage;

    private async Task GetFood()
    {
        try
        {
            var response = await IApiClient.GetAsync<PaginatedList<FoodDto>>
                ($"{IApiClient.NutritionModulePrefix}/food/search?SearchTerm={_prompt}'");
            if (response is { IsSuccess: true, Value: not null })
            {
                _foods = response.Value;
            }
            else
            {
                _errorMessage = response.Message ?? "Failed to load food data";
            }
        }
        catch (Exception e)
        {
            _errorMessage = $"Error: {e.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SubmitPrompt()
    {
        if (string.IsNullOrWhiteSpace(_prompt))
            return;

        _cts?.Cancel();
        _cts = new CancellationTokenSource();

        try
        {
            await Task.Delay(300, _cts.Token);
            await GetFood();
        }
        catch (TaskCanceledException)
        {
        }
    }

    private async Task AddFood()
    {
        if (_model.Barcode is null && _model.FoodId is null)
        {
            _errorMessage = "Please provide either a barcode or a food ID.";
        }

        try
        {
            var response = await IApiClient.PostAsync<PaginatedList<FoodDto>>
            ($"{IApiClient.NutritionModulePrefix}/dailylog/food/add", new
            {
                dailyLogDate = Date,
                mealType = MealType,
                barcode = _model.Barcode ?? null,
                foodId = _model.FoodId ?? null,
                quantityInGrams = _model.QuantityInGrams
            });
            if (response is { IsSuccess: true, Value: not null })
            {
            }
            else
            {
                _errorMessage = response.Message ?? "Failed to add food data";
            }
        }
        catch (Exception e)
        {
            _errorMessage = $"Error: {e.Message}";
        }
        finally
        {
            _isLoading = false;
            Navigation.NavigateTo($"/nutrition/?date={Date.ToString("yyyy-MM-dd")}");
        }
    }

    private async Task SelectedFood(FoodDto food)
    {
        if (food.Barcode is null && food.Id is null)
        {
            _errorMessage = "Please provide either a barcode or a food ID.";
            return;
        }

        _selectedFood = food;
        _model.FoodId = food.Id;
        _model.Barcode = food.Barcode;
    }

    private void ClearSelection()
    {
        _selectedFood = null;
    }

    private void ClearSearch()
    {
        _prompt = string.Empty;
        _foods = null;
    }

    private string GetMealName() => MealType switch
    {
        0 => "Breakfast",
        1 => "Lunch",
        2 => "Dinner",
        3 => "Snack",
        _ => "Meal"
    };

    public class AddFoodModel
    {
        public string? Barcode { get; set; }
        public Guid? FoodId { get; set; }
        public decimal QuantityInGrams { get; set; }
    }

}