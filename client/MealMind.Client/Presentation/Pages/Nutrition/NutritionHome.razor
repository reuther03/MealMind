@page "/nutrition"
@using MealMind.Client.Infrastructure.Abstractions
@using MealMind.Shared.Contracts.Dto.Nutrition
@inject IApiClient IApiClient

<div class="nutrition-page">
    <div class="date-nav">
        <button type="button" class="date-nav-btn" @onclick="NavigatePreviousDay">&#9664;</button>
        <span class="date-nav-title">@_selectedDate.ToString("dddd, MMM d")</span>
        <button type="button" class="date-nav-btn" @onclick="NavigateNextDay">&#9654;</button>
    </div>

    @if (_isLoading)
    {
        <div class="loading-state">
            <span class="loading"></span>
            <span class="text-muted">Loading...</span>
        </div>
    }
    else if (_errorMessage is not null)
    {
        <div class="alert alert-error">@_errorMessage</div>
    }
    else if (_dailyLog is not null)
    {
        <div class="nutrition-content">
            <div class="calorie-card">
                <div class="calorie-header">
                    <div>
                        <span class="calorie-current">@((int)_dailyLog.TotalCalories)</span>
                        <span class="calorie-goal">/ @((int)_dailyLog.CaloriesGoal) cal</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill"
                         style="width: @(Math.Min(GetCaloriePercent(), 100))%; background-color: @GetProgressBarColor()"></div>
                </div>
            </div>

            <div class="macro-grid">
                <div class="macro-card">
                    <div class="macro-label">Protein</div>
                    <div class="macro-value">@((int)_dailyLog.TotalProteins)g</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">Carbs</div>
                    <div class="macro-value">@((int)_dailyLog.TotalCarbohydrates)g</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">Fats</div>
                    <div class="macro-value">@((int)_dailyLog.TotalFats)g</div>
                </div>
            </div>

            @foreach (var meal in _dailyLog.Meals)
            {
                <div class="meal-card">
                    <div class="meal-header">
                        <span class="meal-name">@meal.Name</span>
                        <a href="/nutrition/food-search?meal=@meal.MealType&date=@_dailyLog.CurrentDate.ToString("yyyy-MM-dd")"
                           class="meal-add-btn">+</a>
                    </div>
                    <div class="meal-content">
                        @if (meal.Foods.Any())
                        {
                            @foreach (var food in meal.Foods)
                            {
                                <div class="food-item">
                                    <span class="food-name">@food.FoodName</span>
                                    <span class="food-calories">@((int)food.TotalCalories) cal</span>
                                </div>
                            }

                            <div class="meal-total">Total: @((int)meal.TotalCalories) cal</div>
                        }
                        else
                        {
                            <div class="meal-empty">No foods added</div>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <p class="text-muted">No daily log available.</p>
        </div>
    }
</div>

@code {

    [SupplyParameterFromQuery]
    public DateOnly? Date { get; set; }

    private DailyLogDto? _dailyLog;
    private DateOnly _selectedDate;

    private string? _errorMessage;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        _selectedDate = Date ?? DateOnly.FromDateTime(DateTime.Now);
        await GetDailyLog();
    }

    private async Task GetDailyLog()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var response = await IApiClient.GetAsync<DailyLogDto>
                ($"{IApiClient.NutritionModulePrefix}/dailylog?date={_selectedDate:yyyy-MM-dd}");

            if (response.IsSuccess)
            {
                _dailyLog = response.Value;
            }
            else
            {
                _errorMessage = response.Message ?? "Failed to load daily log for the selected date";
            }
        }
        catch (Exception e)
        {
            _errorMessage = $"Error: {e.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private int GetCaloriePercent()
    {
        if (_dailyLog?.CaloriesGoal is null or 0) return 0;
        return (int)((_dailyLog.TotalCalories * 100) / _dailyLog.CaloriesGoal);
    }

    private string GetProgressBarColor()
    {
        var percent = GetCaloriePercent();
        return percent switch
        {
            > 100 => "#ef4444",
            > 95 => "#eab308",
            _ => "#22c55e"
        };
    }

    private async Task NavigateNextDay()
    {
        _selectedDate = _selectedDate.AddDays(1);
        await GetDailyLog();
    }

    private async Task NavigatePreviousDay()
    {
        _selectedDate = _selectedDate.AddDays(-1);
        await GetDailyLog();
    }

}