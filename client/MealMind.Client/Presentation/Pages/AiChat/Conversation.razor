@page "/ai-chat/{ConversationId:guid}"
@using System.Text.Json
@using MealMind.Client.Infrastructure.Abstractions
@using MealMind.Shared.Contracts.Dto.AiChat
@inject IApiClient ApiClient
@inject IJSRuntime Js

<div class="chat-page">
    <div class="chat-header">
        <a href="/ai-chat/" class="back-btn">← Back</a>
        <h2 class="chat-title">@_conversation?.Title</h2>
    </div>

    @if (_isLoading)
    {
        <div class="loading-state">
            <span class="loading"></span>
            <span class="text-muted">Loading...</span>
        </div>
    }
    else if (_errorMessage is not null)
    {
        <div class="alert alert-error">@_errorMessage</div>
    }
    else if (_conversation is not null)
    {
        <div class="messages-container" id="messages-container">
            @if (_conversation.ChatMessages.Count == 0)
            {
                <div class="empty-messages">No messages yet</div>
            }
            else
            {
                @foreach (var message in _conversation.ChatMessages)
                {
                    @if (message.Role == nameof(AiChatRole.Assistant))
                    {
                        var structured = JsonSerializer.Deserialize<StructuredResponse>(message.Content)!;
                        <div class="message assistant">
                            <div class="message-role">Assistant</div>
                            @foreach (var p in structured.Paragraphs)
                            {
                                <p>@p</p>
                            }
                            @if (structured.KeyPoints.Any())
                            {
                                <div class="message-keypoints">
                                    <div class="message-keypoints-label">Key Points</div>
                                    <ol>
                                        @foreach (var point in structured.KeyPoints)
                                        {
                                            <li>@point</li>
                                        }
                                    </ol>
                                </div>
                            }
                            <div class="message-time">@message.CreatedAt.ToString("h:mm tt")</div>
                        </div>
                    }
                    else
                    {
                        <div class="message user">
                            <p>@message.Content</p>
                            <div class="message-time">@message.CreatedAt.ToString("h:mm tt")</div>
                        </div>
                    }
                }
            }
        </div>

        <div class="prompt-area">
            <div class="prompt-box">
                <input type="text"
                       class="prompt-input"
                       @bind="_prompt"
                       placeholder="Type a message..."
                       maxlength="1000"
                       disabled="@_isSubmitting" />
                <button class="send-btn" @onclick="SubmitPrompt" disabled="@_isSubmitting">
                    @(_isSubmitting ? "..." : "Send")
                </button>
            </div>
        </div>
    }
</div>

@code {

    [Parameter]
    public Guid ConversationId { get; set; }

    private ConversationDetailsDto? _conversation;
    private string _prompt = string.Empty;
    private string? _errorMessage;
    private bool _isLoading = true;
    private bool _isSubmitting;

    protected override async Task OnInitializedAsync()
    {
        await FetchConversation();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await ScrollToBottom();
    }

    private async Task FetchConversation()
    {
        try
        {
            var response = await ApiClient.GetAsync<ConversationDetailsDto>($"{IApiClient.AiChatModulePrefix}/conversation/{ConversationId}");

            if (response is { IsSuccess: true, Value: not null })
            {
                _conversation = response.Value;
            }
            else
            {
                _errorMessage = response.Message ?? "Failed to load conversation";
            }
        }
        catch (Exception e)
        {
            _errorMessage = $"Error: {e.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SubmitPrompt()
    {
        if (string.IsNullOrWhiteSpace(_prompt)) return;

        _isSubmitting = true;

        try
        {
            var response = await ApiClient.PostAsync<ConversationDetailsDto>(
                $"{IApiClient.AiChatModulePrefix}/{ConversationId}/get-chat-response", new
                {
                    Prompt = _prompt
                });

            if (response is { IsSuccess: true, Value: not null })
            {
                _prompt = string.Empty;
                await FetchConversation();
            }
            else
            {
                _errorMessage = response.Message ?? "Failed to send message";
            }
        }
        catch (Exception e)
        {
            _errorMessage = $"Error: {e.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task ScrollToBottom()
    {
        await Js.InvokeVoidAsync("eval",
            "document.getElementById('messages-container')?.scrollTo(0, document.getElementById('messages-container')?.scrollHeight)");
    }

}