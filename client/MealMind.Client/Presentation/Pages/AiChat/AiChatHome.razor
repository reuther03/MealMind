@page "/ai-chat/"
@using MealMind.Client.Infrastructure.Abstractions
@using MealMind.Shared.Contracts.Dto.AiChat
@using MealMind.Shared.Contracts.Pagination
@inject IApiClient ApiClient

<div class="chat-home">
    <div class="chat-header">
        <h1>AI Chat</h1>
        <p class="text-muted">Your nutrition assistant</p>
    </div>

    <a href="/ai-chat/new" class="btn btn-primary btn-block btn-lg mb-6">
        + Start New Chat
    </a>

    @if (_isLoading)
    {
        <div class="loading-state">
            <span class="loading"></span>
            <span class="text-muted">Loading conversations...</span>
        </div>
    }
    else if (_errorMessage is not null)
    {
        <div class="alert alert-error">@_errorMessage</div>
    }
    else if (_conversations is not null)
    {
        <div class="conversations-section">
            <h3 class="section-label">Recent Conversations</h3>

            @if (_conversations.Items.Count == 0)
            {
                <div class="empty-state">
                    <p class="text-muted">No conversations yet.</p>
                    <p class="text-muted text-sm">Start a new chat to get nutrition advice!</p>
                </div>
            }
            else
            {
                <div class="conversation-list">
                    @foreach (var conversation in _conversations.Items)
                    {
                        <a href="/ai-chat/@conversation.Id" class="conversation-card">
                            <div class="conversation-title">@conversation.Title</div>
                            <div class="conversation-meta">
                                Last used @conversation.LastUsedAt.ToString("MMM d, yyyy")
                            </div>
                        </a>
                    }
                </div>

                @if (_conversations.TotalPages > 1)
                {
                    <div class="pagination">
                        <button class="btn btn-ghost btn-sm" @onclick="PreviousPage" disabled="@(!_conversations.HasPrevious)">
                            Previous
                        </button>
                        <span class="pagination-info text-muted text-sm">
                            @_conversations.Page / @_conversations.TotalPages
                        </span>
                        <button class="btn btn-ghost btn-sm" @onclick="NextPage" disabled="@(!_conversations.HasNext)">
                            Next
                        </button>
                    </div>
                }
            }
        </div>
    }

    <div class="quick-links">
        <a href="/ai-chat/image-analyze" class="btn btn-secondary btn-block">
            Analyze Food Image
        </a>
    </div>
</div>

@code {
    private PaginatedList<ConversationDto>? _conversations;
    private string? _errorMessage;
    private bool _isLoading = true;
    private int _currentPage = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadConversations();
    }

    private async Task LoadConversations()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var response = await ApiClient.GetAsync<PaginatedList<ConversationDto>>($"{IApiClient.AiChatModulePrefix}/get-conversations?page={_currentPage}");

            if (response.IsSuccess)
            {
                _conversations = response.Value;
            }
            else
            {
                _errorMessage = response.Message ?? "Failed to load conversations";
            }
        }
        catch (Exception e)
        {
            _errorMessage = $"Error: {e.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task PreviousPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            await LoadConversations();
        }
    }

    private async Task NextPage()
    {
        _currentPage++;
        await LoadConversations();
    }

}