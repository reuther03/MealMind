@page "/register"
@using System.ComponentModel.DataAnnotations
@using MealMind.Client.Application.State
@using MealMind.Client.Infrastructure.Abstractions
@using MealMind.Shared.Contracts.Types
@inject AuthState AuthState
@inject IApiClient ApiClient
@inject NavigationManager Navigation

<div class="register-page">
    <div class="register-header">
        <h1>Create Account</h1>
        <p class="text-muted">Fill in your details to get started</p>
    </div>

    <EditForm Model="@_model" OnValidSubmit="HandleRegister">
        <DataAnnotationsValidator/>

        <div class="form-section">
            <h3 class="section-title">Account</h3>

            <div class="form-group">
                <label class="form-label">Username</label>
                <InputText @bind-Value="_model.Username" class="input" placeholder="Choose a username"/>
                <ValidationMessage For="@(() => _model.Username)"/>
            </div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <InputText @bind-Value="_model.Email" class="input" placeholder="your@email.com"/>
                <ValidationMessage For="@(() => _model.Email)"/>
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <InputText @bind-Value="_model.Password" type="password" class="input" placeholder="Create a password"/>
                <ValidationMessage For="@(() => _model.Password)"/>
            </div>
        </div>

        <div class="form-section">
            <h3 class="section-title">Personal Info</h3>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Gender</label>
                    <InputSelect @bind-Value="_model.Gender" class="input select">
                        @foreach (var gender in Enum.GetValues(typeof(Gender)))
                        {
                            <option value="@gender">@gender</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">Date of Birth</label>
                    <InputDate @bind-Value="_model.DateOfBirth" class="input"/>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Weight (kg)</label>
                    <InputNumber @bind-Value="_model.Weight" class="input" placeholder="75"/>
                </div>

                <div class="form-group">
                    <label class="form-label">Height (cm)</label>
                    <InputNumber @bind-Value="_model.Height" class="input" placeholder="180"/>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Target Weight (kg)</label>
                    <InputNumber @bind-Value="_model.WeightTarget" class="input" placeholder="70"/>
                </div>

                <div class="form-group">
                    <label class="form-label">Activity Level</label>
                    <InputSelect @bind-Value="_model.ActivityLevel" class="input select">
                        @foreach (var activity in Enum.GetValues(typeof(ActivityLevel)))
                        {
                            <option value="@activity">@activity</option>
                        }
                    </InputSelect>
                </div>
            </div>
        </div>

        @foreach (var (plan, index) in _model.NutritionTargets.Select((value, i) => (value, i)))
        {
            <div class="plan-card">
                <div class="plan-card-header">
                    <span class="plan-card-title">Plan @(index + 1)</span>
                    @if (_model.NutritionTargets.Count > 1)
                    {
                        <button type="button" class="plan-card-remove" @onclick="() => RemovePlan(index)">
                            Remove
                        </button>
                    }
                </div>

                <div class="day-grid">
                    @foreach (var day in Enum.GetValues<DayOfWeek>())
                    {
                        var isSelected = plan.ActiveDays.Contains((int)day);
                        var isUsedByOther = IsDayUsedByOtherPlan(index, (int)day);

                        <div class="day-card @(isSelected ? "selected" : "") @(isUsedByOther ? "disabled" : "")"
                             @onclick="() => ToggleActiveDay(index, (int)day, !isSelected)">
                            <span class="day-name">@day.ToString().Substring(0, 3)</span>
                            <span class="day-check">âœ“</span>
                        </div>
                    }
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Daily Calories</label>
                        <InputNumber @bind-Value="plan.Calories" class="input" placeholder="2000"/>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Water Intake (ml)</label>
                        <InputNumber @bind-Value="plan.WaterIntake" class="input" placeholder="2500"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Macros Mode</label>
                    <InputSelect @bind-Value="plan.UseGrams" class="input select">
                        <option value="true">Grams</option>
                        <option value="false">Percentage</option>
                    </InputSelect>
                </div>

                @if (plan.UseGrams)
                {
                    <div class="form-row-3">
                        <div class="form-group">
                            <label class="form-label">Protein (g)</label>
                            <InputNumber @bind-Value="plan.ProteinInGrams" class="input"
                                         placeholder="150"/>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Carbs (g)</label>
                            <InputNumber @bind-Value="plan.CarbohydratesInGrams" class="input"
                                         placeholder="200"/>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Fats (g)</label>
                            <InputNumber @bind-Value="plan.FatsInGrams" class="input"
                                         placeholder="65"/>
                        </div>
                    </div>
                }
                else
                {
                    <div class="form-row-3">
                        <div class="form-group">
                            <label class="form-label">Protein (%)</label>
                            <InputNumber @bind-Value="plan.ProteinPercentage" class="input"
                                         placeholder="30"/>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Carbs (%)</label>
                            <InputNumber @bind-Value="plan.CarbohydratesPercentage" class="input"
                                         placeholder="40"/>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Fats (%)</label>
                            <InputNumber @bind-Value="plan.FatsPercentage" class="input"
                                         placeholder="30"/>
                        </div>
                    </div>
                }
            </div>
        }

        @if (_errorMessage is not null)
        {
            <div class="alert alert-error">@_errorMessage</div>
        }

        @if (GetRemainingDaysCount() > 0)
        {
            <div class="alert alert-warning">
                @GetRemainingDaysCount() days not assigned
            </div>
            <button type="button" class="btn btn-secondary btn-block" @onclick="AddPlan">
                + Add Another Plan
            </button>
        }
        else
        {
            <div class="alert alert-success">
                All 7 days covered
            </div>
        }
        <button type="submit" class="btn btn-primary btn-block btn-lg" disabled="@_isLoading">
            @if (_isLoading)
            {
                <span class="loading"></span>
                <span>Creating Account...</span>
            }
            else
            {
                <span>Create Account</span>
            }
        </button>
    </EditForm>
    <div class="register-footer">
        <p class="text-muted text-sm"> Already have an account ? <a href="/login"> Sign in</a></p>
    </div>
</div>

@code {
    private readonly RegisterModel _model = new();
    private bool _isLoading;
    private string? _errorMessage;

    private async Task HandleRegister()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var result = await ApiClient.PostAsync<Guid>($"{IApiClient.IdentityModulePrefix}/sign-up", new
            {
                username = _model.Username,
                email = _model.Email,
                inputPassword = _model.Password,
                personalData = new
                {
                    gender = _model.Gender,
                    dateOfBirth = _model.DateOfBirth,
                    weight = _model.Weight,
                    height = _model.Height,
                    weightTarget = _model.WeightTarget,
                    activityLevel = _model.ActivityLevel
                },
                nutritionTargets = _model.NutritionTargets.Select(t => new
                {
                    calories = t.Calories,
                    useGrams = t.UseGrams,
                    proteinInGrams = t.ProteinInGrams,
                    carbohydratesInGrams = t.CarbohydratesInGrams,
                    fatsInGrams = t.FatsInGrams,
                    proteinPercentage = t.ProteinPercentage,
                    carbohydratesPercentage = t.CarbohydratesPercentage,
                    fatsPercentage = t.FatsPercentage,
                    waterIntake = t.WaterIntake,
                    activeDays = t.ActiveDays
                }).ToList()
            });

            if (result is
                {
                    IsSuccess: false
                })
                _errorMessage = result.Message;

            else
            {
                Navigation.NavigateTo("/login");
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ToggleActiveDay(int index, int day, bool isChecked)
    {
        if (isChecked && IsDayUsedByOtherPlan(index, day))
            return;

        switch (isChecked)
        {
            case true when !_model.NutritionTargets[index].ActiveDays.Contains(day):
                _model.NutritionTargets[index].ActiveDays.Add(day);
                break;
            case false:
                _model.NutritionTargets[index].ActiveDays.Remove(day);
                break;
        }
    }

    private void AddPlan()
    {
        if (GetRemainingDaysCount() > 0)
            _model.NutritionTargets.Add(new NutritionTargetModel());
    }

    private int GetRemainingDaysCount()
    {
        var assignedDays = new HashSet<int>();

        foreach (var plan in _model.NutritionTargets)
        {
            foreach (var day in plan.ActiveDays)
            {
                assignedDays.Add(day);
            }
        }

        return 7 - assignedDays.Count;
    }

    private void RemovePlan(int index)
    {
        if (index >= 0 && index < _model.NutritionTargets.Count)
        {
            _model.NutritionTargets.RemoveAt(index);
        }
    }

    private bool IsDayUsedByOtherPlan(int index, int day)
    {
        return _model.NutritionTargets.Where((t, i) => i != index && t.ActiveDays.Contains(day)).Any();
    }

    public class RegisterModel
    {
        [Required(ErrorMessage = "Username is required")]
        public string Username { get; set; } = "";

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Password is required")]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [Required]
        public Gender Gender { get; set; }

        [Required]
        public DateOnly DateOfBirth { get; set; } = DateOnly.FromDateTime(DateTime.Now.AddYears(-18));

        [Required]
        [Range(0.1, double.MaxValue, ErrorMessage = "Weight must be greater than 0")]
        public double Weight { get; set; }

        [Required]
        [Range(0.1, double.MaxValue, ErrorMessage = "Height must be greater than 0")]
        public double Height { get; set; }

        [Required]
        [Range(0.1, double.MaxValue, ErrorMessage = "Weight target must be greater than 0")]
        public double WeightTarget { get; set; }

        [Required]
        public ActivityLevel ActivityLevel { get; set; }

        public List<NutritionTargetModel> NutritionTargets = [new()];
    }

    public class NutritionTargetModel
    {
        [Range(0, int.MaxValue)]
        public int Calories { get; set; }

        public bool UseGrams { get; set; } = true;

        [Range(0, double.MaxValue)]
        public double ProteinInGrams { get; set; }

        [Range(0, double.MaxValue)]
        public double CarbohydratesInGrams { get; set; }

        [Range(0, double.MaxValue)]
        public double FatsInGrams { get; set; }

        [Range(0, 100)]
        public double ProteinPercentage { get; set; }

        [Range(0, 100)]
        public double CarbohydratesPercentage { get; set; }

        [Range(0, 100)]
        public double FatsPercentage { get; set; }

        [Range(0, int.MaxValue)]
        public int WaterIntake { get; set; }

        public List<int> ActiveDays { get; set; } = [];
    }

}